books.alexwlchan.net {
	import redirects.Caddyfile

	# Enable compression for responses
	encode zstd gzip

	# Add long-lived caching headers for specific paths
	@cached {
		path /favicons/* /individual_covers/* /static/* /thumbs/*
	}

	header @cached {
		Cache-Control "public, max-age=31536000"
	}

	# Add some security headers.
	# I test my security headers with https://securityheaders.com/
	header {
		# https://scotthelme.co.uk/hardening-your-http-response-headers/#content-security-policy
		Content-Security-Policy "default-src ; style-src 'self' 'unsafe-inline'; img-src 'self' data:; script-src 'self' 'unsafe-inline' https://unpkg.com/;connect-src https://analytics.alexwlchan.net/;"

		# https://scotthelme.co.uk/a-new-security-header-feature-policy/
		# https://scotthelme.co.uk/goodbye-feature-policy-and-hello-permissions-policy/
		Permissions-Policy "geolocation=(), midi=(), notifications=(), push=(), sync-xhr=(), microphone=(), camera=(), magnetometer=(), gyroscope=(), vibrate=(), payment=()"

		# https://scotthelme.co.uk/a-new-security-header-referrer-policy/
		Referrer-Policy "no-referrer-when-downgrade"

		# https://scotthelme.co.uk/hardening-your-http-response-headers/#strict-transport-security
		Strict-Transport-Security "max-age=31536000; includeSubDomains"

		# https://scotthelme.co.uk/hardening-your-http-response-headers/#x-content-type-options
		X-Content-Type-Options "nosniff"

		# https://scotthelme.co.uk/hardening-your-http-response-headers/#x-frame-options
		X-Frame-Options "DENY"

		# https://scotthelme.co.uk/hardening-your-http-response-headers/#x-xss-protection
		X-Xss-Protection "1; mode=block"
	}

	root * /home/alexwlchan/repos/books.alexwlchan.net/_site
	file_server
	try_files {path} {path}/

	log {
		output file /var/log/caddy/books.log

		# This removes personally identifiable information (PII) from the logs,
		# in particular:
		#
		#    - IP addresses
		#    - User-Agents
		#
		# They're not useful to me so I might as well discard them.
		format filter {
			wrap json
			fields {
				request>remote_ip delete
				request>remote_port delete
				request>client_ip delete
				request>headers>User-Agent delete
			}
		}
	}
}
